# shellcheck disable=SC2034,SC2154,SC2164

_sdkver='8.0.302'

pkgname='ryujinx-git'
pkgver=1.1.1336.r0.g0afa8f2
pkgrel=1
pkgdesc="Experimental Nintendo Switch Emulator written in C#"
arch=('x86_64')
url='https://www.ryujinx.org/'
license=('MIT')
depends=('zlib' 'hicolor-icon-theme' 'libx11' 'fontconfig')
makedepends=('git' 'desktop-file-utils')
provides=("${pkgname/-git/}")
conflicts=("${pkgname/-git/}")
source=(
  "git+https://github.com/Ryujinx/Ryujinx"
  "https://dotnetcli.azureedge.net/dotnet/Sdk/$_sdkver/dotnet-sdk-$_sdkver-linux-x64.tar.gz"
)
noextract=("dotnet-sdk-$_sdkver-linux-x64.tar.gz")
sha256sums=('SKIP'
            '8c84340e7bbbe478463debb9230e18d5b1a94583c2ebc04eb28a39a232b37f55')
b2sums=('SKIP'
        '56d7ade37162a3dbbd248f50a278338bf5a3d019b8001bb60e33e2a050c4e38cf3fecd958ed8bb6b7fb0fde9646bcc29e0d5aecfc13435ae9a6f2a8f0105c34f')

options=(!strip !debug)

pkgver() {
  cd "Ryujinx"

  git describe --long --tags --abbrev=7 | sed 's/\([^-]*-g\)/r\1/;s/-/./g'
}

build() {
  DOTNET_ROOT="$PWD/dotnet"
  export DOTNET_ROOT

  rm -rf "$DOTNET_ROOT"
  mkdir "$DOTNET_ROOT"
  tar zxf dotnet-sdk-$_sdkver-linux-x64.tar.gz -C "$DOTNET_ROOT"
  export PATH=$DOTNET_ROOT:$DOTNET_ROOT/tools:$PATH

  cd "Ryujinx"

  dotnet clean
  dotnet nuget locals all -c
  dotnet publish src/Ryujinx \
    --configuration Release \
    --output ../publish \
    -p:DebugType=embedded \
    -p:ExtraDefineConstants=DISABLE_UPDATER%2CFORCE_EXTERNAL_BASE_DIR \
    -p:Version="$(git describe --tags)" \
    --runtime linux-x64 \
    --self-contained
}

package() {
  mkdir -pv "$pkgdir/opt/ryujinx/"
  mkdir -pv "$pkgdir/usr/bin/"

  install -D "Ryujinx/distribution/linux/Ryujinx.desktop" "$pkgdir/usr/share/applications/ryujinx.desktop"
  install -D "Ryujinx/distribution/misc/Logo.svg" "$pkgdir/usr/share/icons/hicolor/scalable/apps/ryujinx.svg"

  cp -Rv "publish/"* "$pkgdir/opt/ryujinx/"

  cat <<EOF > "$pkgdir/usr/bin/ryujinx"
#!/usr/bin/env bash

env DOTNET_EnableAlternateStackCheck=1 /opt/ryujinx/Ryujinx
EOF
  chmod -v +x "$pkgdir/usr/bin/ryujinx"


  desktop-file-edit --set-key="Exec" --set-value="nice -n -10 ryujinx %f" "$pkgdir/usr/share/applications/ryujinx.desktop"
  desktop-file-edit --set-key="StartupWMClass" --set-value="Ryujinx" "$pkgdir/usr/share/applications/ryujinx.desktop"
  desktop-file-edit --set-icon="ryujinx" "$pkgdir/usr/share/applications/ryujinx.desktop"
}
